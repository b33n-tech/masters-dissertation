<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Workspace MÃ©moire Pro - Trame par paragraphe</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f4f6f8; color: #333; }
    h1 { color: #1f3c88; }
    .section, .subsection, .note, .paragraph { border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .subsection { margin-left: 20px; }
    .note { margin-left: 40px; background: #fff7e6; font-size: 0.9em; padding: 5px 10px; }
    .paragraph { margin-left: 20px; background: #f0f0f5; }
    textarea, input { width: 100%; padding: 5px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin: 5px 3px 5px 0; padding: 5px 10px; border-radius: 5px; border:none; cursor:pointer; background:#1f3c88; color:white; }
    button:hover { background:#1452a0; }
    .flex { display:flex; gap:5px; align-items:center; margin-bottom:5px; }
    #workspace { max-width: 1000px; margin-top: 20px; }
    input[type=file] { padding: 3px; }
    .word-count { font-size:0.85em; color:#555; margin-top:5px; }
    .fold-btn { background:#777; }
    .fold-btn:hover { background:#555; }
</style>
</head>
<body>

<h1>Workspace MÃ©moire Pro - Trame par paragraphe</h1>

<div>
    <button onclick="addSection()">âž• Ajouter une section</button>
    <button onclick="exportJSON()">ðŸ’¾ Export JSON</button>
    <button onclick="exportMarkdown()">ðŸ“„ Export Markdown</button>
    <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)">
</div>

<div id="workspace"></div>

<script>
let plan = [
    {titre:"Abstract", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Introduction", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Literature Review", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Methodology", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Results", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Discussion", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Conclusion", paragraphs:[], sous:[], targetWords:0, folded:false},
    {titre:"Annexes", paragraphs:[], sous:[], targetWords:0, folded:false}
];

function countWords(str){ return str.trim() ? str.trim().split(/\s+/).length : 0; }

function render(){
    const ws = document.getElementById("workspace");
    ws.innerHTML="";
    plan.forEach((sec,i)=>{
        const secDiv = document.createElement("div");
        secDiv.className="section";

        // Header + repli
        const header = document.createElement("div"); header.className="flex";
        const foldBtn=document.createElement("button"); foldBtn.textContent=sec.folded?"â–¶":"â–¼"; foldBtn.className="fold-btn";
        foldBtn.onclick=()=>{ sec.folded=!sec.folded; render(); };
        header.appendChild(foldBtn);

        const hInput = document.createElement("input"); hInput.type="text"; hInput.value=sec.titre; hInput.oninput=(e)=> sec.titre=e.target.value; hInput.style.flex="1";
        header.appendChild(hInput);

        const up = document.createElement("button"); up.textContent="â†‘"; up.onclick=()=> moveSection(i,-1);
        const down = document.createElement("button"); down.textContent="â†“"; down.onclick=()=> moveSection(i,1);
        const del = document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>{ plan.splice(i,1); render(); };
        header.append(up,down,del);
        secDiv.appendChild(header);

        if(!sec.folded){
            // Target words
            const targetDiv=document.createElement("div"); targetDiv.className="flex";
            const targetLabel=document.createElement("span"); targetLabel.textContent="Objectif mots :";
            const targetInput=document.createElement("input"); targetInput.type="number"; targetInput.value=sec.targetWords;
            targetInput.oninput=(e)=> sec.targetWords=parseInt(e.target.value)||0;
            targetDiv.append(targetLabel,targetInput);
            secDiv.appendChild(targetDiv);

            // Paragraphs
            sec.paragraphs.forEach((p,j)=>{
                const pDiv=document.createElement("div"); pDiv.className="paragraph";
                const pHeader=document.createElement("div"); pHeader.className="flex";
                const paraLabel=document.createElement("span"); paraLabel.textContent=`Paragraphe ${j+1}`;
                pHeader.appendChild(paraLabel);
                const delP=document.createElement("button"); delP.textContent="âŒ"; delP.onclick=()=>{ sec.paragraphs.splice(j,1); render(); };
                pHeader.appendChild(delP);
                pDiv.appendChild(pHeader);

                const ta=document.createElement("textarea"); ta.rows=3; ta.value=p; ta.oninput=(e)=> sec.paragraphs[j]=e.target.value;
                pDiv.appendChild(ta);

                secDiv.appendChild(pDiv);
            });
            const addP=document.createElement("button"); addP.textContent="âž• Ajouter paragraphe";
            addP.onclick=()=>{ sec.paragraphs.push(""); render(); };
            secDiv.appendChild(addP);

            // Word count
            const secWords=sec.paragraphs.reduce((a,b)=>a+countWords(b),0)+sec.sous.reduce((a,b)=>a+countWords(b.paragraphs.reduce((aa,bb)=>aa+countWords(bb),0)),0);
            const percent = sec.targetWords>0 ? Math.min(100, Math.round(secWords/sec.targetWords*100)) : 0;
            const wc=document.createElement("div"); wc.className="word-count"; wc.textContent=`Mots comptÃ©s: ${secWords} | Couverture: ${percent}%`;
            secDiv.appendChild(wc);

            // Sous-parties
            sec.sous.forEach((sub,j)=>{
                const subDiv=document.createElement("div"); subDiv.className="subsection";
                if(!sub.folded){
                    const subHeader=document.createElement("div"); subHeader.className="flex";
                    const subFoldBtn=document.createElement("button"); subFoldBtn.textContent=sub.folded?"â–¶":"â–¼"; subFoldBtn.className="fold-btn";
                    subFoldBtn.onclick=()=>{ sub.folded=!sub.folded; render(); };
                    subHeader.appendChild(subFoldBtn);

                    const subInput=document.createElement("input"); subInput.type="text"; subInput.value=sub.titre; subInput.style.flex="1";
                    subInput.oninput=(e)=> sub.titre=e.target.value;
                    subHeader.appendChild(subInput);

                    const upS=document.createElement("button"); upS.textContent="â†‘"; upS.onclick=()=> moveSub(i,j,-1);
                    const downS=document.createElement("button"); downS.textContent="â†“"; downS.onclick=()=> moveSub(i,j,1);
                    const delS=document.createElement("button"); delS.textContent="âŒ"; delS.onclick=()=>{ sec.sous.splice(j,1); render(); };
                    subHeader.append(upS,downS,delS);
                    subDiv.appendChild(subHeader);

                    // Paragraphs sous-section
                    sub.paragraphs.forEach((p2,k)=>{
                        const pDiv2=document.createElement("div"); pDiv2.className="paragraph";
                        const pLabel=document.createElement("span"); pLabel.textContent=`Paragraphe ${k+1}`;
                        const delP2=document.createElement("button"); delP2.textContent="âŒ"; delP2.onclick=()=>{ sub.paragraphs.splice(k,1); render(); };
                        pDiv2.appendChild(pLabel); pDiv2.appendChild(delP2);
                        const ta2=document.createElement("textarea"); ta2.rows=2; ta2.value=p2; ta2.oninput=(e)=> sub.paragraphs[k]=e.target.value;
                        pDiv2.appendChild(ta2);
                        subDiv.appendChild(pDiv2);
                    });
                    const addP2=document.createElement("button"); addP2.textContent="âž• Ajouter paragraphe"; addP2.onclick=()=>{ sub.paragraphs.push(""); render(); };
                    subDiv.appendChild(addP2);
                } else {
                    const titleFolded=document.createElement("div"); titleFolded.textContent=sub.titre+" ..."; titleFolded.style.fontStyle="italic"; subDiv.appendChild(titleFolded);
                }

                // Word count sous-section
                const subWords=sub.paragraphs.reduce((a,b)=>a+countWords(b),0);
                const subWC=document.createElement("div"); subWC.className="word-count"; subWC.textContent=`Mots: ${subWords}`;
                subDiv.appendChild(subWC);

                secDiv.appendChild(subDiv);
            });

            const addSubBtn=document.createElement("button"); addSubBtn.textContent="âž• Ajouter sous-partie";
            addSubBtn.onclick=()=>{ sec.sous.push({titre:"Nouvelle sous-partie",paragraphs:[],notes:[],folded:false}); render(); };
            secDiv.appendChild(addSubBtn);
        }

        ws.appendChild(secDiv);
    });
}

function addSection(){ plan.push({titre:"Nouvelle section",paragraphs:[],sous:[],targetWords:0,folded:false}); render(); }
function moveSection(i,d){ const j=i+d; if(j<0||j>=plan.length)return; [plan[i],plan[j]]=[plan[j],plan[i]]; render(); }
function moveSub(i,j,d){ const k=j+d; if(k<0||k>=plan[i].sous.length)return; [plan[i].sous[j],plan[i].sous[k]]=[plan[i].sous[k],plan[i].sous[j]]; render(); }

function exportJSON(){ const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(plan,null,2)); const dl=document.createElement("a"); dl.setAttribute("href",dataStr); dl.setAttribute("download","plan_memoire.json"); dl.click(); }

function exportMarkdown(){
    let md="";
    plan.forEach(p=>{
        md+="# "+p.titre+"\n\n";
        p.paragraphs.forEach((para,k)=>{ md+=`### Paragraphe ${k+1}\n${para}\n\n`; });
        p.sous.forEach(sp=>{
            md+="## "+sp.titre+"\n\n";
            sp.paragraphs.forEach((para2,k)=>{ md+=`### Paragraphe ${k+1}\n${para2}\n\n`; });
            if(sp.notes.length>0){ md+="### Notes\n"; sp.notes.forEach(n=>md+=`- [${n.tag}] ${n.texte}\n`); md+="\n"; }
        });
        md+="---\n\n";
    });
    const dataStr="data:text/markdown;charset=utf-8,"+encodeURIComponent(md);
    const dl=document.createElement("a"); dl.setAttribute("href",dataStr); dl.setAttribute("download","plan_memoire.md"); dl.click();
}

function importJSON(event){
    const file=event.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(e){
        try{ plan=JSON.parse(e.target.result); render(); }catch(err){ alert("JSON invalide"); }
    }
    reader.readAsText(file);
}

render();
</script>

</body>
</html>

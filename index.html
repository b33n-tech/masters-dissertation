<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan M√©moire ‚Äì Builder</title>
<style>
body {
  font-family: "Inter", sans-serif;
  background: #f8f9fb;
  margin: 0;
  padding: 20px;
  color: #333;
}
.container {
  max-width: 900px;
  margin: auto;
}
.section {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  margin-bottom: 16px;
  padding: 16px;
  transition: 0.2s;
}
.section:hover {
  box-shadow: 0 5px 12px rgba(0,0,0,0.15);
}
.section h2 {
  margin: 0 0 10px;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
textarea {
  width: 100%;
  height: 120px;
  margin-top: 10px;
  padding: 10px;
  font-size: 0.95rem;
  border-radius: 8px;
  border: 1px solid #ddd;
  resize: vertical;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  margin: 4px 4px 0 0;
  cursor: pointer;
  transition: 0.2s;
}
button:hover {
  background: #1d4ed8;
}
.wordcount {
  font-size: 0.9em;
  color: #666;
  margin-top: 5px;
}
.paragraph {
  background: #f4f6fa;
  border-radius: 8px;
  margin: 10px 0;
  padding: 8px;
  transition: 0.2s;
  position: relative;
}
.paragraph:hover {
  background: #e9eef6;
}
.paragraph-controls {
  text-align: right;
  margin-bottom: 4px;
}
.add-paragraph-inline {
  display: block;
  width: 100%;
  text-align: center;
  margin: 4px 0;
  cursor: pointer;
  color: #2563eb;
  font-size: 0.9em;
  background: none;
  border: none;
}
.add-paragraph-inline:hover {
  text-decoration: underline;
}
.progress {
  height: 6px;
  border-radius: 4px;
  background: #e5e7eb;
  margin-top: 5px;
}
.progress-bar {
  height: 6px;
  border-radius: 4px;
  background: #2563eb;
  width: 0%;
  transition: width 0.3s;
}
</style>
</head>
<body>
<div class="container">
  <h1>üß† Plan d√©taill√© du m√©moire</h1>
  <input type="file" id="uploadJSON" accept=".json"><br><br>
  <div id="sections"></div>
  <button onclick="downloadJSON()">üíæ Export JSON</button>
</div>

<script>
let data = [];

function countWords(text) {
  return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

function render() {
  const container = document.getElementById('sections');
  container.innerHTML = '';

  data.forEach((section, sIndex) => {
    const div = document.createElement('div');
    div.className = 'section';

    const header = document.createElement('h2');
    header.innerHTML = `${section.titre} <small style="color:#999;">(${section.targetWords} mots vis√©s)</small>`;
    header.onclick = () => section.folded = !section.folded;
    div.appendChild(header);

    if (!section.folded) {
      const textarea = document.createElement('textarea');
      textarea.value = section.contenu;
      textarea.oninput = e => { section.contenu = e.target.value; updateProgress(); };
      div.appendChild(textarea);

      const wordcount = document.createElement('div');
      wordcount.className = 'wordcount';
      const words = countWords(section.contenu);
      const pct = Math.min(100, (words / section.targetWords * 100).toFixed(1));
      wordcount.innerHTML = `üìù ${words} / ${section.targetWords} mots (${pct}%)`;
      const progress = document.createElement('div');
      progress.className = 'progress';
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      bar.style.width = pct + '%';
      progress.appendChild(bar);
      div.appendChild(wordcount);
      div.appendChild(progress);

      // Paragraph list
      section.paragraphs.forEach((p, pIndex) => {
        const pDiv = document.createElement('div');
        pDiv.className = 'paragraph';
        
        const controls = document.createElement('div');
        controls.className = 'paragraph-controls';
        controls.innerHTML = `
          <button onclick="removeParagraph(${sIndex}, ${pIndex})">üóëÔ∏è</button>
        `;
        pDiv.appendChild(controls);

        const pText = document.createElement('textarea');
        pText.value = p;
        pText.oninput = e => { section.paragraphs[pIndex] = e.target.value; updateProgress(); };
        pDiv.appendChild(pText);

        // Add paragraph *below* current one
        const addBelow = document.createElement('button');
        addBelow.className = 'add-paragraph-inline';
        addBelow.textContent = '+ Ajouter un paragraphe ici';
        addBelow.onclick = () => addParagraphAt(sIndex, pIndex + 1);
        pDiv.appendChild(addBelow);

        div.appendChild(pDiv);
      });

      const addTop = document.createElement('button');
      addTop.className = 'add-paragraph-inline';
      addTop.textContent = '+ Ajouter un paragraphe au d√©but';
      addTop.onclick = () => addParagraphAt(sIndex, 0);
      div.insertBefore(addTop, textarea.nextSibling);

      if (section.paragraphs.length === 0) {
        const addFirst = document.createElement('button');
        addFirst.className = 'add-paragraph-inline';
        addFirst.textContent = '+ Ajouter un premier paragraphe';
        addFirst.onclick = () => addParagraphAt(sIndex, 0);
        div.appendChild(addFirst);
      }
    }

    container.appendChild(div);
  });
}

function addParagraphAt(sectionIndex, position) {
  data[sectionIndex].paragraphs.splice(position, 0, '');
  render();
}

function removeParagraph(sectionIndex, paragraphIndex) {
  data[sectionIndex].paragraphs.splice(paragraphIndex, 1);
  render();
}

function updateProgress() {
  render();
}

function downloadJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plan_memoire.json";
  a.click();
}

document.getElementById('uploadJSON').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      data = JSON.parse(ev.target.result);
      render();
    } catch (err) {
      alert("JSON invalide");
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>

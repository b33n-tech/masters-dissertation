<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß† Plan M√©moire Builder</title>
<style>
body {
  font-family: "Inter", sans-serif;
  background: #f8f9fb;
  margin: 0;
  padding: 20px;
  color: #333;
}
.container {
  max-width: 900px;
  margin: auto;
}
.section {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  margin-bottom: 16px;
  padding: 16px;
  transition: 0.2s;
}
.section:hover {
  box-shadow: 0 6px 14px rgba(0,0,0,0.15);
}
.section h2 {
  margin: 0 0 10px;
  cursor: pointer;
  font-size: 1.2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
textarea {
  width: 100%;
  height: 120px;
  margin-top: 10px;
  padding: 10px;
  font-size: 0.95rem;
  border-radius: 8px;
  border: 1px solid #ddd;
  resize: vertical;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  margin: 4px 4px 0 0;
  cursor: pointer;
  transition: 0.2s;
}
button:hover {
  background: #1d4ed8;
}
.wordcount {
  font-size: 0.9em;
  color: #666;
  margin-top: 5px;
}
.progress {
  height: 6px;
  border-radius: 4px;
  background: #e5e7eb;
  margin-top: 5px;
  overflow: hidden;
}
.progress-bar {
  height: 6px;
  border-radius: 4px;
  background: #2563eb;
  width: 0%;
  transition: width 0.3s ease;
}
.paragraph {
  background: #f4f6fa;
  border-radius: 8px;
  margin: 10px 0;
  padding: 8px;
  transition: 0.2s;
}
.paragraph:hover {
  background: #e9eef6;
}
.paragraph-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}
.add-paragraph-inline {
  display: block;
  width: 100%;
  text-align: center;
  margin: 6px 0;
  cursor: pointer;
  color: #2563eb;
  font-size: 0.9em;
  background: none;
  border: none;
  font-weight: 500;
}
.add-paragraph-inline:hover {
  text-decoration: underline;
}
input.target {
  width: 80px;
  padding: 4px;
  margin-left: 8px;
  border-radius: 6px;
  border: 1px solid #ddd;
  font-size: 0.9em;
}
.badge {
  font-size: 0.8em;
  padding: 2px 6px;
  border-radius: 6px;
  color: white;
  margin-left: 6px;
}
.badge.low { background: #f97316; }
.badge.mid { background: #eab308; }
.badge.high { background: #16a34a; }
</style>
</head>
<body>
<div class="container">
  <h1>üß© Plan d√©taill√© du m√©moire</h1>
  <input type="file" id="uploadJSON" accept=".json"><br><br>
  <div id="sections"></div>
  <button onclick="downloadJSON()">üíæ Export JSON</button>
</div>

<script>
let data = [];

function countWords(text) {
  return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

function render() {
  const container = document.getElementById('sections');
  container.innerHTML = '';

  data.forEach((section, sIndex) => {
    const div = document.createElement('div');
    div.className = 'section';

    const header = document.createElement('h2');
    header.innerHTML = `${section.titre}`;
    header.onclick = () => {
      section.folded = !section.folded;
      render();
    };
    div.appendChild(header);

    if (!section.folded) {
      const targetInput = document.createElement('input');
      targetInput.type = 'number';
      targetInput.className = 'target';
      targetInput.value = section.targetWords || 0;
      targetInput.oninput = e => {
        section.targetWords = parseInt(e.target.value) || 0;
        updateWordcount(div, section);
      };
      div.appendChild(document.createTextNode("Objectif de mots :"));
      div.appendChild(targetInput);

      const textarea = document.createElement('textarea');
      textarea.value = section.contenu;
      textarea.oninput = e => {
        section.contenu = e.target.value;
        updateWordcount(div, section);
      };
      div.appendChild(textarea);

      const wordcount = document.createElement('div');
      wordcount.className = 'wordcount';
      const progress = document.createElement('div');
      progress.className = 'progress';
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      progress.appendChild(bar);

      div.appendChild(wordcount);
      div.appendChild(progress);
      updateWordcount(div, section);

      const addAtTop = document.createElement('button');
      addAtTop.className = 'add-paragraph-inline';
      addAtTop.textContent = '+ Ajouter un paragraphe en haut';
      addAtTop.onclick = () => addParagraphAt(sIndex, 0);
      div.appendChild(addAtTop);

      section.paragraphs.forEach((p, pIndex) => {
        const pDiv = document.createElement('div');
        pDiv.className = 'paragraph';

        const controls = document.createElement('div');
        controls.className = 'paragraph-controls';

        const target = document.createElement('input');
        target.type = 'number';
        target.className = 'target';
        target.value = p.targetWords || 0;
        target.oninput = e => p.targetWords = parseInt(e.target.value) || 0;

        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.onclick = () => removeParagraph(sIndex, pIndex);

        controls.appendChild(document.createTextNode(`Paragraphe ${pIndex + 1}`));
        controls.appendChild(target);
        controls.appendChild(delBtn);
        pDiv.appendChild(controls);

        const pText = document.createElement('textarea');
        pText.value = p.text || '';
        pText.oninput = e => p.text = e.target.value;
        pDiv.appendChild(pText);

        div.appendChild(pDiv);

        const addBetween = document.createElement('button');
        addBetween.className = 'add-paragraph-inline';
        addBetween.textContent = '+ Ajouter un paragraphe ici';
        addBetween.onclick = () => addParagraphAt(sIndex, pIndex + 1);
        div.appendChild(addBetween);
      });

      if (section.paragraphs.length === 0) {
        const addFirst = document.createElement('button');
        addFirst.className = 'add-paragraph-inline';
        addFirst.textContent = '+ Ajouter un premier paragraphe';
        addFirst.onclick = () => addParagraphAt(sIndex, 0);
        div.appendChild(addFirst);
      }
    }

    container.appendChild(div);
  });
}

function updateWordcount(div, section) {
  const wordcount = div.querySelector('.wordcount');
  const bar = div.querySelector('.progress-bar');
  const words = countWords(section.contenu);
  const target = section.targetWords || 0;
  const pct = target ? Math.min(100, (words / target * 100).toFixed(1)) : 0;

  let badgeClass = "low";
  if (pct > 66) badgeClass = "high";
  else if (pct > 33) badgeClass = "mid";

  wordcount.innerHTML = `üìù ${words} / ${target || "?"} mots (${pct}%) <span class="badge ${badgeClass}">${badgeClass.toUpperCase()}</span>`;
  bar.style.width = pct + '%';
}

function addParagraphAt(sectionIndex, position) {
  data[sectionIndex].paragraphs.splice(position, 0, { text: "", targetWords: 0 });
  render();
}

function removeParagraph(sectionIndex, paragraphIndex) {
  data[sectionIndex].paragraphs.splice(paragraphIndex, 1);
  render();
}

function downloadJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plan_memoire.json";
  a.click();
}

document.getElementById('uploadJSON').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      data = JSON.parse(ev.target.result);
      render();
    } catch (err) {
      alert("JSON invalide");
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>

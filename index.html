<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Workspace MÃ©moire Pro avec compteur</title>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f4f6f8; color: #333; }
    h1 { color: #1f3c88; }
    .section, .subsection, .note { border-radius: 8px; padding: 10px; margin-bottom: 10px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .subsection { margin-left: 20px; }
    .note { margin-left: 40px; background: #fff7e6; font-size: 0.9em; padding: 5px 10px; }
    textarea, input { width: 100%; padding: 5px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin: 5px 3px 5px 0; padding: 5px 10px; border-radius: 5px; border:none; cursor:pointer; background:#1f3c88; color:white; }
    button:hover { background:#1452a0; }
    .flex { display:flex; gap:5px; align-items:center; margin-bottom:5px; }
    #workspace { max-width: 1000px; margin-top: 20px; }
    input[type=file] { padding: 3px; }
    .word-count { font-size:0.85em; color:#555; margin-top:5px; }
    .fold-btn { background:#777; }
    .fold-btn:hover { background:#555; }
</style>
</head>
<body>

<h1>Workspace MÃ©moire Pro avec compteur</h1>

<div>
    <button onclick="addSection()">âž• Ajouter une section</button>
    <button onclick="exportJSON()">ðŸ’¾ Export JSON</button>
    <button onclick="exportMarkdown()">ðŸ“„ Export Markdown</button>
    <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)">
</div>

<div id="workspace"></div>

<script>
let plan = [
    {titre:"Abstract", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Introduction", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Literature Review", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Methodology", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Results", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Discussion", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Conclusion", contenu:"", sous:[], targetWords:0, folded:false},
    {titre:"Annexes", contenu:"", sous:[], targetWords:0, folded:false}
];

function countWords(str){ return str.trim() ? str.trim().split(/\s+/).length : 0; }

function render(){
    const ws = document.getElementById("workspace");
    ws.innerHTML="";
    plan.forEach((sec,i)=>{
        const secDiv = document.createElement("div");
        secDiv.className="section";

        const header = document.createElement("div");
        header.className="flex";
        const foldBtn=document.createElement("button"); foldBtn.textContent=sec.folded?"â–¶":"â–¼"; foldBtn.className="fold-btn";
        foldBtn.onclick=()=>{ sec.folded=!sec.folded; render(); };
        header.appendChild(foldBtn);

        const hInput = document.createElement("input");
        hInput.type="text"; hInput.value=sec.titre; hInput.oninput=(e)=> sec.titre=e.target.value; hInput.style.flex="1";
        header.appendChild(hInput);

        const up = document.createElement("button"); up.textContent="â†‘"; up.onclick=()=> moveSection(i,-1);
        const down = document.createElement("button"); down.textContent="â†“"; down.onclick=()=> moveSection(i,1);
        const del = document.createElement("button"); del.textContent="âŒ"; del.onclick=()=>{ plan.splice(i,1); render(); };
        header.append(up,down,del);
        secDiv.appendChild(header);

        if(!sec.folded){
            const ta = document.createElement("textarea"); ta.rows=4; ta.value=sec.contenu; ta.oninput=(e)=> sec.contenu=e.target.value; 
            secDiv.appendChild(ta);

            // Target words input
            const targetDiv=document.createElement("div"); targetDiv.className="flex";
            const targetLabel=document.createElement("span"); targetLabel.textContent="Objectif mots :";
            const targetInput=document.createElement("input"); targetInput.type="number"; targetInput.value=sec.targetWords;
            targetInput.oninput=(e)=> sec.targetWords=parseInt(e.target.value)||0;
            targetDiv.append(targetLabel,targetInput);
            secDiv.appendChild(targetDiv);

            // Word count
            const totalWords=countWords(sec.contenu)+sec.sous.reduce((a,b)=>a+countWords(b.contenu),0);
            const percent = sec.targetWords>0 ? Math.min(100, Math.round(totalWords/sec.targetWords*100)) : 0;
            const wc=document.createElement("div"); wc.className="word-count";
            wc.textContent=`Mots comptÃ©s: ${totalWords} | Couverture: ${percent}%`;
            secDiv.appendChild(wc);

            // Sous-parties
            sec.sous.forEach((sub,j)=>{
                const subDiv=document.createElement("div"); subDiv.className="subsection";
                if(!sub.folded){
                    const subHeader=document.createElement("div"); subHeader.className="flex";
                    const subFoldBtn=document.createElement("button"); subFoldBtn.textContent=sub.folded?"â–¶":"â–¼"; subFoldBtn.className="fold-btn";
                    subFoldBtn.onclick=()=>{ sub.folded=!sub.folded; render(); };
                    subHeader.appendChild(subFoldBtn);

                    const subInput=document.createElement("input"); subInput.type="text"; subInput.value=sub.titre; subInput.style.flex="1";
                    subInput.oninput=(e)=> sub.titre=e.target.value;
                    subHeader.appendChild(subInput);

                    const upS=document.createElement("button"); upS.textContent="â†‘"; upS.onclick=()=> moveSub(i,j,-1);
                    const downS=document.createElement("button"); downS.textContent="â†“"; downS.onclick=()=> moveSub(i,j,1);
                    const delS=document.createElement("button"); delS.textContent="âŒ"; delS.onclick=()=>{ plan[i].sous.splice(j,1); render(); };
                    subHeader.append(upS,downS,delS);
                    subDiv.appendChild(subHeader);

                    const subTa=document.createElement("textarea"); subTa.rows=3; subTa.value=sub.contenu; subTa.oninput=(e)=> sub.contenu=e.target.value;
                    subDiv.appendChild(subTa);

                    // Notes
                    sub.notes.forEach((n,k)=>{
                        const nDiv=document.createElement("div"); nDiv.className="note"; nDiv.textContent=`[${n.tag}] ${n.texte}`;
                        const delN=document.createElement("button"); delN.textContent="âŒ"; delN.onclick=()=>{ sub.notes.splice(k,1); render(); };
                        nDiv.appendChild(delN);
                        subDiv.appendChild(nDiv);
                    });

                    const noteInput=document.createElement("input"); noteInput.placeholder="Nouvelle note";
                    const tagInput=document.createElement("input"); tagInput.placeholder="Tag";
                    const addNoteBtn=document.createElement("button"); addNoteBtn.textContent="Ajouter note";
                    addNoteBtn.onclick=()=>{ if(noteInput.value.trim()!==""){ sub.notes.push({texte:noteInput.value.trim(),tag:tagInput.value.trim()}); render(); } };
                    subDiv.append(noteInput,tagInput,addNoteBtn);
                } else {
                    const titleFolded=document.createElement("div"); titleFolded.textContent=sub.titre+" ..."; titleFolded.style.fontStyle="italic"; subDiv.appendChild(titleFolded);
                }

                const subWords=countWords(sub.contenu);
                const subWC=document.createElement("div"); subWC.className="word-count"; subWC.textContent=`Mots: ${subWords}`;
                subDiv.appendChild(subWC);

                secDiv.appendChild(subDiv);
            });

            const addSubBtn=document.createElement("button"); addSubBtn.textContent="âž• Ajouter sous-partie";
            addSubBtn.onclick=()=>{ sec.sous.push({titre:"Nouvelle sous-partie",contenu:"",notes:[],folded:false}); render(); };
            secDiv.appendChild(addSubBtn);
        }

        ws.appendChild(secDiv);
    });
}

function addSection(){ plan.push({titre:"Nouvelle section",contenu:"",sous:[],targetWords:0,folded:false}); render(); }
function moveSection(i,d){ const j=i+d; if(j<0||j>=plan.length)return; [plan[i],plan[j]]=[plan[j],plan[i]]; render(); }
function moveSub(i,j,d){ const k=j+d; if(k<0||k>=plan[i].sous.length)return; [plan[i].sous[j],plan[i].sous[k]]=[plan[i].sous[k],plan[i].sous[j]]; render(); }

function exportJSON(){ const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(plan,null,2)); const dl=document.createElement("a"); dl.setAttribute("href",dataStr); dl.setAttribute("download","plan_memoire.json"); dl.click(); }

function exportMarkdown(){
    let md="";
    plan.forEach(p=>{
        md+="# "+p.titre+"\n\n"+p.contenu+"\n\n";
        p.sous.forEach(sp=>{
            md+="## "+sp.titre+"\n\n"+sp.contenu+"\n\n";
            if(sp.notes.length>0){ md+="### Notes\n"; sp.notes.forEach(n=>md+=`- [${n.tag}] ${n.texte}\n`); md+="\n"; }
        });
        md+="---\n\n";
    });
    const dataStr="data:text/markdown;charset=utf-8,"+encodeURIComponent(md);
    const dl=document.createElement("a"); dl.setAttribute("href",dataStr); dl.setAttribute("download","plan_memoire.md"); dl.click();
}

function importJSON(event){
    const file=event.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=function(e){
        try{ plan=JSON.parse(e.target.result); render(); }catch(err){ alert("JSON invalide"); }
    }
    reader.readAsText(file);
}

render();
</script>

</body>
</html>
